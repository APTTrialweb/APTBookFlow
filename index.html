<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APT BookFlow — Coordinator Console</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass: rgba(255,255,255,0.03)}
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;background:linear-gradient(180deg,#071025 0%, #071428 50%, #02121a 100%);color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
    .wrap{width:1100px;max-width:100%;display:grid;grid-template-columns:380px 1fr;gap:28px}

    /* Left panel */
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:22px;border-radius:14px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{margin:0;font-size:18px}
    p.lead{color:var(--muted);margin:8px 0 18px;font-size:13px}

    /* form */
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;font-size:14px}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px}
    .btn{background:linear-gradient(90deg,var(--accent),#7c3aed);border:none;color:#02121a;font-weight:700;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .row{display:flex;gap:10px}
    .field{margin-bottom:12px}

    /* Right panel */
    .right{display:flex;flex-direction:column;gap:12px}
    .card{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.03)}
    .scanner-area{height:360px;display:flex;align-items:center;justify-content:center;border-radius:10px;overflow:hidden;background:#03121a}
    .meta{display:flex;gap:12px;flex-wrap:wrap}
    .meta > div{min-width:160px}
    .success{color:#10b981}
    .error{color:#ef4444}
    footer.note{color:var(--muted);font-size:13px;margin-top:10px}

    /* responsive */
    @media (max-width:980px){.wrap{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="panel">
      <div class="brand">
        <div class="logo">BF</div>
        <div>
          <h1>APT BookFlow</h1>
          <p class="lead">Coordinator console — scan QR, enter remaining, push updates to Google Sheets.</p>
        </div>
      </div>

      <div id="loginView">
        <div class="field">
          <label>Coordinator ID</label>
          <input id="coordId" placeholder="e.g. C123" />
        </div>
        <div class="field">
          <label>Password</label>
          <input id="coordPass" type="password" placeholder="password" />
        </div>
        <div class="field row">
          <button class="btn" id="loginBtn">Login</button>
          <button class="btn ghost" id="demoBtn">Demo Mode</button>
        </div>
        <p class="muted small">Tip: Deploy the included Google Apps Script and paste the Web App URL into the settings (bottom).</p>
      </div>

      <div id="settingsView" style="display:none;margin-top:12px">
        <div class="field">
          <label>Google Apps Script Web App URL</label>
          <input id="webAppUrl" placeholder="https://script.google.com/...." />
        </div>
        <div class="field">
          <label>Batch ID</label>
          <input id="batchId" placeholder="Batch-2025-01" />
        </div>
        <div class="field">
          <label>Transfered To Batch (optional)</label>
          <input id="transferBatch" placeholder="(leave empty if none)" />
        </div>
        <div class="field row">
          <button class="btn" id="saveSettings">Save Settings</button>
          <button class="btn ghost" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div id="statusBox" style="display:none;margin-top:18px">
        <div class="card small" id="statusMsg">Logged in as <span id="who"></span></div>
      </div>

      <div style="margin-top:18px;font-size:13px;color:var(--muted)">
        <strong>Fields that will be sent to your sheet:</strong>
        <ul style="margin:8px 0 0;padding-left:18px;color:var(--muted)">
          <li>CoordinatorID, BatchID, Book Name, Class, Total Books, Issued Count, Remaining, Last Issued Date, Issued By, QR Code, Transfered To Batch, Date & Time</li>
        </ul>
      </div>

      <div style="margin-top:12px" class="small muted">Built with ❤️ — adjust Apps Script to match your sheet column order. See the "Apps Script" tab in the UI for the example code.</div>

    </aside>

    <main class="right">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 style="margin:0">Scanner</h3>
            <div class="muted small">Scan the QR attached to the sealed box before opening.</div>
          </div>
          <div class="muted small">Live time: <span id="timeNow"></span></div>
        </div>

        <div class="scanner-area" id="scanner">
          <div id="reader" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
            <div class="muted">Scanner will appear here after login</div>
          </div>
        </div>

        <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="field">
            <label>QR Code (scanned)</label>
            <input id="qrCode" readonly />
          </div>
          <div class="field">
            <label>Book Name</label>
            <input id="bookName" placeholder="Book title (optional)" />
          </div>
          <div class="field">
            <label>Class</label>
            <input id="bookClass" placeholder="e.g. 8th" />
          </div>
          <div class="field">
            <label>Total Books (on package)</label>
            <input id="totalBooks" type="number" placeholder="e.g. 100" />
          </div>
          <div class="field">
            <label>Issued Count (to be issued now)</label>
            <input id="issuedCount" type="number" placeholder="e.g. 20" />
          </div>
          <div class="field">
            <label>Remaining (auto-calculated or enter manually)</label>
            <input id="remaining" type="number" placeholder="calculated: total - issued" />
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn" id="submitBtn">Submit to Sheet</button>
          <button class="btn ghost" id="calcBtn">Calc Remaining</button>
          <button class="btn ghost" id="copyJson">Copy JSON</button>
        </div>

        <div id="resultMsg" style="margin-top:10px"></div>
      </div>

      <div class="card" id="appsScriptCard">
        <h3 style="margin:0">Google Apps Script (paste into script.google.com)</h3>
        <p class="muted small">Deploy as Web App (Execute as: Me, Who has access: Anyone with link). The endpoint will accept POST JSON and update the sheet. After deployment, paste the Web App URL into settings.</p>
        <pre style="white-space:pre-wrap;background:#02121a;padding:10px;border-radius:8px;overflow:auto;font-size:13px">// Example Google Apps Script doPost handler
function doPost(e){
  try{
    var params = JSON.parse(e.postData.contents);
    var ss = SpreadsheetApp.openById('YOUR_SPREADSHEET_ID'); // replace
    var sheet = ss.getSheetByName('Responses') || ss.getActiveSheet();

    // Example column order — adapt to your sheet
    // Columns: Date & Time, CoordinatorID, BatchID, Book Name, Class, Total Books, Issued Count, Remaining, Last Issued Date, Issued By, QR Code, Transfered To Batch

    var now = new Date();
    var row = [now, params.CoordinatorID, params.BatchID, params.BookName || '', params.Class || '', params.TotalBooks || '', params.IssuedCount || '', params.Remaining || '', params.LastIssuedDate || '', params.IssuedBy || '', params.QRCode || '', params.TransferedToBatch || ''];
    sheet.appendRow(row);

    return ContentService.createTextOutput(JSON.stringify({status:'ok'})).setMimeType(ContentService.MimeType.JSON);
  }catch(err){
    return ContentService.createTextOutput(JSON.stringify({status:'error', message:err.message})).setMimeType(ContentService.MimeType.JSON);
  }
}
</pre>
        <footer class="note">Make sure to set your spreadsheet ID and column order. Lock down access if needed; consider OAuth or an Apps Script key for security.</footer>
      </div>
    </main>
  </div>

  <!-- external library for QR scanning -->
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
  <script>
    // ========== CONFIG
    const WEB_APP_URL_KEY = 'apt_bookflow_webapp_url';
    const BATCH_ID_KEY = 'apt_bookflow_batch_id';

    // ========== tiny state
    let coordinator = null;
    let html5QrcodeScanner = null;

    // update clock
    function tick(){
      document.getElementById('timeNow').innerText = new Date().toLocaleString();
    }
    setInterval(tick,1000); tick();

    // login actions
    document.getElementById('loginBtn').addEventListener('click', ()=>{
      const id = document.getElementById('coordId').value.trim();
      const pass = document.getElementById('coordPass').value.trim();
      if(!id || !pass){ alert('Enter credentials'); return; }
      // For demo, we accept any credentials — production: validate on server
      coordinator = {id, name: id, password: pass};
      afterLogin();
    });

    document.getElementById('demoBtn').addEventListener('click', ()=>{
      coordinator = {id:'DEMO', name:'Demo Coordinator'};
      afterLogin();
    });

    function afterLogin(){
      document.getElementById('loginView').style.display='none';
      document.getElementById('settingsView').style.display='block';
      document.getElementById('statusBox').style.display='block';
      document.getElementById('who').innerText = coordinator.name + ' ('+coordinator.id+')';
      // prefill saved settings
      const savedUrl = localStorage.getItem(WEB_APP_URL_KEY) || '';
      const savedBatch = localStorage.getItem(BATCH_ID_KEY) || '';
      document.getElementById('webAppUrl').value = savedUrl;
      document.getElementById('batchId').value = savedBatch;

      startScanner();
    }

    document.getElementById('saveSettings').addEventListener('click', ()=>{
      localStorage.setItem(WEB_APP_URL_KEY, document.getElementById('webAppUrl').value.trim());
      localStorage.setItem(BATCH_ID_KEY, document.getElementById('batchId').value.trim());
      alert('Settings saved locally');
    });

    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      if(html5QrcodeScanner) html5QrcodeScanner.stop().catch(()=>{});
      coordinator = null;
      document.getElementById('loginView').style.display='block';
      document.getElementById('settingsView').style.display='none';
      document.getElementById('statusBox').style.display='none';
      document.getElementById('reader').innerHTML = '<div class="muted">Scanner will appear here after login</div>';
    });

    // start scanner
    function startScanner(){
      const reader = document.getElementById('reader');
      reader.innerHTML = '<div id="qr-reader" style="width:100%"></div>';
      const qrRegionId = 'qr-reader';
      html5QrcodeScanner = new Html5Qrcode(qrRegionId);

      const config = { fps: 10, qrbox: { width: 300, height: 200 } };
      html5QrcodeScanner.start({ facingMode: 'environment'}, config, qrMessage => {
        // when a QR code is detected
        document.getElementById('qrCode').value = qrMessage;
        // try auto-fill some fields if QR carries JSON-like data
        try{
          const parsed = JSON.parse(qrMessage);
          if(parsed.bookName) document.getElementById('bookName').value = parsed.bookName;
          if(parsed.class) document.getElementById('bookClass').value = parsed.class;
          if(parsed.totalBooks) document.getElementById('totalBooks').value = parsed.totalBooks;
        }catch(e){/* not JSON, ignore */}

      }, err => {
        // ignore scan errors
      }).catch(err => {
        document.getElementById('resultMsg').innerHTML = '<div class="error">Unable to start camera: '+err+'</div>';
      });
    }


    // calculate remaining
    document.getElementById('calcBtn').addEventListener('click', ()=>{
      const total = Number(document.getElementById('totalBooks').value) || 0;
      const issued = Number(document.getElementById('issuedCount').value) || 0;
      const rem = total - issued;
      document.getElementById('remaining').value = rem >= 0 ? rem : 0;
    });

    // copy JSON
    document.getElementById('copyJson').addEventListener('click', ()=>{
      const payload = buildPayload();
      navigator.clipboard.writeText(JSON.stringify(payload, null, 2)).then(()=>{
        alert('JSON copied to clipboard');
      }).catch(()=>alert('Could not copy'));
    });

    function buildPayload(){
      const now = new Date().toISOString();
      const payload = {
        "Date & Time": now,
        CoordinatorID: coordinator ? coordinator.id : document.getElementById('coordId').value.trim(),
        BatchID: document.getElementById('batchId').value.trim() || '',
        BookName: document.getElementById('bookName').value.trim(),
        Class: document.getElementById('bookClass').value.trim(),
        TotalBooks: Number(document.getElementById('totalBooks').value) || '',
        IssuedCount: Number(document.getElementById('issuedCount').value) || '',
        Remaining: Number(document.getElementById('remaining').value) || '',
        LastIssuedDate: now,
        IssuedBy: coordinator ? coordinator.name : '',
        QRCode: document.getElementById('qrCode').value.trim(),
        TransferedToBatch: document.getElementById('transferBatch').value.trim() || ''
      };
      return payload;
    }

    // submit to Apps Script
    document.getElementById('submitBtn').addEventListener('click', async ()=>{
      const url = document.getElementById('webAppUrl').value.trim();
      if(!url){ alert('Please paste your Google Apps Script Web App URL in settings and Save.'); return; }
      if(!coordinator){ alert('Please login first'); return; }
      const payload = buildPayload();
      document.getElementById('resultMsg').innerHTML = '<div class="muted">Sending...</div>';
      try{
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if(data && data.status === 'ok'){
          document.getElementById('resultMsg').innerHTML = '<div class="success">Update saved to sheet ✅</div>';
        }else{
          document.getElementById('resultMsg').innerHTML = '<div class="error">Error from server: '+(data && data.message ? data.message : JSON.stringify(data))+'</div>';
        }
      }catch(err){
        document.getElementById('resultMsg').innerHTML = '<div class="error">Network error: '+err.message+'</div>';
      }
    });

    // helper: stop scanner on page unload
    window.addEventListener('beforeunload', ()=>{
      if(html5QrcodeScanner){ try{ html5QrcodeScanner.stop(); }catch(e){} }
    });
  </script>
</body>
</html>
